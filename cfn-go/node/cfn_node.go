package node

import (
	"github.com/9triver/cfn/cfn-go/models"
	"github.com/asynkron/protoactor-go/actor"
)

func (p RouterEntry) toPID() *actor.PID {
	return actor.NewPID(p.Address, p.Id)
}

type CFNNode struct {

	//==================================================================================================================
	// Actor 核心
	//------------------------------------------------------------------------------------------------------------------

	actorCore *Controller

	//==================================================================================================================
	// 请求路由器
	//------------------------------------------------------------------------------------------------------------------

	requestRouter *RequestRouter

	//==================================================================================================================
	// Web 通信
	//------------------------------------------------------------------------------------------------------------------

	webUrl string

	//==================================================================================================================
	// 节点状态
	//------------------------------------------------------------------------------------------------------------------

	resource *models.Resource

	//==================================================================================================================
	// 守护线程
	//------------------------------------------------------------------------------------------------------------------

	daemonThread *DaemonThread
}

//======================================================================================================================
// Actor 核心
//----------------------------------------------------------------------------------------------------------------------

func (node *CFNNode) GetPID() *actor.PID {
	return node.actorCore.GetPID()
}

//======================================================================================================================
// 请求路由器
//----------------------------------------------------------------------------------------------------------------------

func (node *CFNNode) AddNeighbor(pid string) {
	node.requestRouter.addNeighbor(pid)
}

// ---------------------------------------------------------------------------------------------------------------------
// 创建和启动
//----------------------------------------------------------------------------------------------------------------------

func NewHeadNode() *CFNNode {
	node := &CFNNode{}

	// 初始化 Actor
	node.actorCore = NewController(node)
	// 初始化请求路由表
	node.requestRouter = NewRequestRouter(node)
	// 初始化守护线程
	node.daemonThread = NewDaemonThread(node)

	return node
}

func (node *CFNNode) StartHeadNode(host string, port int, name string, neighborPIDs []string) *actor.PID {
	node.actorCore.Start(host, port, name)
	node.daemonThread.Start()
	return nil
}
